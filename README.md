# PyQt工作工具开发文档

## 项目概述

本项目是一个基于PyQt的模块化工作工具，采用插件式架构，支持功能的动态扩展。左侧为功能导航区，右侧为功能工作区，界面简洁清晰。

项目集成了多种实用工具，包括：
- 文本处理工具
- 文件管理器
- 系统工具
- 月汇总工具（运输数据分析）
- Excel合并工具
- Excel去重工具
- 图片水印工具
- 插件管理器

## 系统架构

### 主要组件

1. **主窗口 (MainWindow)**
   - 负责整体布局管理
   - 处理功能模块间的切换
   - 管理菜单和状态栏

2. **功能管理器 (PluginManager)**
   - 负责加载和管理所有功能模块
   - 提供统一的接口用于功能注册和获取
   - 支持动态添加新功能

3. **导航面板 (NavigationPanel)**
   - 显示所有已加载的功能模块
   - 提供功能切换界面
   - 支持功能分类和搜索

4. **功能工作区 (Workspace)**
   - 显示当前选中的功能界面
   - 为每个功能提供独立的显示区域
   - 管理功能间的切换动画

5. **功能基类 (BasePlugin)**
   - 所有功能模块的基础类
   - 定义标准接口方法
   - 提供通用功能支持

## 目录结构

```
d:/work-tools/
├── main.py                     # 应用程序入口
├── README.md                   # 项目文档
├── requirements.txt            # 依赖包列表
├── build.py                    # 构建脚本
├── WorkTools.spec              # PyInstaller配置文件
├── setup_github_deploy.py      # GitHub部署脚本
├── version.json                # 应用版本信息
├── CNAME                       # 域名配置
├── .gitignore                  # Git忽略文件配置
├── .github/                    # GitHub Actions配置
│   ├── scripts/
│   └── workflows/
├── docs/                       # 文档目录
│   ├── 磨刀不误砍柴功，何况AI是【瞬时磨刀器】.md
│   ├── DEPLOY.md               # 部署文档
│   ├── GITHUB_DEPLOY.md        # GitHub部署说明
│   └── RELEASE.md              # 发布说明
└── worktools/                  # 主应用包
    ├── __init__.py
    ├── app.py                  # 主应用类
    ├── main_window.py          # 主窗口实现
    ├── navigation.py           # 导航面板
    ├── workspace.py            # 工作区管理
    ├── plugin_manager.py       # 插件管理器
    ├── base_plugin.py          # 插件基类
    ├── api_settings_dialog.py  # API设置对话框
    ├── updater.py              # 更新管理器
    ├── resources/              # 资源文件
    │   └── icons/              # 图标资源
    │       └── app.png
    └── plugins/                # 功能插件目录
        ├── __init__.py
        ├── plugin1.py          # 文本处理工具
        ├── plugin2.py          # 文件管理器
        ├── plugin3.py          # 系统工具
        ├── monthly_summary.py  # 月汇总工具
        ├── excel_merger.py     # Excel合并工具
        ├── excel_deduplication.py  # Excel去重工具
        ├── image_watermark.py  # 图片水印工具
        └── plugin_manager_tool.py  # 插件管理器
```

## 功能接口规范

### 插件基类 (BasePlugin)

```python
class BasePlugin(QWidget):
    """所有功能插件的基础类"""
    
    def __init__(self, parent=None):
        super().__init__(parent)
    
    def get_name(self) -> str:
        """返回插件显示名称"""
        raise NotImplementedError
    
    def get_description(self) -> str:
        """返回插件描述信息"""
        raise NotImplementedError
    
    def get_icon(self) -> QIcon:
        """返回插件图标"""
        raise NotImplementedError
    
    def initialize(self):
        """插件初始化，加载资源等"""
        pass
    
    def on_activate(self):
        """当插件被激活时调用"""
        pass
    
    def on_deactivate(self):
        """当插件被停用时调用"""
        pass
    
    def save_state(self) -> dict:
        """保存插件状态"""
        return {}
    
    def restore_state(self, state: dict):
        """恢复插件状态"""
        pass
    
    # 插件设置接口（二选一）
    def get_settings_widget(self) -> QWidget:
        """
        返回插件设置界面控件（可选）
        
        Returns:
            设置界面控件，如果插件没有设置选项则返回None
        """
        return None
    
    def _show_settings_dialog(self):
        """
        显示插件设置对话框（可选，优先使用此方法）
        
        子类可以重写此方法来显示自定义设置对话框
        """
        pass
    
    def has_settings(self) -> bool:
        """
        检查插件是否有设置选项（自动判断，无需手动实现）
        
        Returns:
            True表示有设置选项，False表示没有
        """
        # 自动检测是否实现了 _show_settings_dialog 或 get_settings_widget
        pass
```

### 插件设置接口规范

为了支持统一的插件管理，插件需要实现以下设置接口之一：

**方式1：实现 `_show_settings_dialog()` 方法（推荐）**
```python
def _show_settings_dialog(self):
    """显示插件设置对话框"""
    dialog = MySettingsDialog(self)
    dialog.exec_()
```

**方式2：实现 `get_settings_widget()` 方法**
```python
def get_settings_widget(self) -> QWidget:
    """返回插件设置界面控件"""
    return MySettingsWidget()
```

**设置按钮自动启用/禁用**：
- 当插件实现上述任一方法时，工作区标题栏右侧的"设置"按钮会自动启用
- 未实现任何设置接口的插件，"设置"按钮显示为灰色不可用

## 预设功能模块

### 1. 文本处理工具 (TextProcessor)
- **功能描述**: 提供常用文本处理功能
- **主要特性**: 文本格式化、编码转换、正则表达式匹配等
- **扩展接口**: 可添加自定义文本处理函数

### 2. 文件管理器 (FileManager)
- **功能描述**: 增强的文件管理和操作工具
- **主要特性**: 文件批量重命名、搜索、属性查看等
- **扩展接口**: 可添加自定义文件操作

### 3. 系统工具 (SystemTools)
- **功能描述**: 常用系统工具集合
- **主要特性**: 进程管理、系统信息查看等
- **扩展接口**: 可添加自定义系统工具

### 4. 月汇总工具 (MonthlySummary)
- **功能描述**: 运输数据汇总和分析工具
- **主要特性**: 
  - 自动识别车牌号并判断运输方式（汽提/装船）
  - 根据产地自动分类运输类别（水运/铁运/汽运）
  - 生成汇总统计表并导出Excel
  - 支持自定义车牌号修正和产地类别映射
- **使用说明**: 
  1. 选择Excel数据文件，需包含"提货车号"、"产地"、"实发量"、"实发件数"等列
  2. 配置车牌号修正规则，处理常见输入错误（如"卾"修正为"鄂"）
  3. 配置产地到运输类别的映射关系
  4. 点击"处理数据"自动分析并生成汇总表
  5. 可保存结果到新的Excel文件，包含原始数据和汇总表

### 5. Excel合并工具 (ExcelMerger)
- **功能描述**: 用于处理具有多层级结构的Excel表格合并
- **主要特性**: 
  - 双模式支持：多文件合并和单文件多工作表合并
  - 支持跳过顶部标题行（如报告标题、副标题等）
  - 支持自定义列标题行位置
  - 支持跳过底部合计行（各种"合计"、"总计"等）
  - 支持批量添加文件或整个文件夹
  - 支持单个文件的多工作表预览
  - 可选择性添加文件来源列或工作表来源列
  - 提供数据预览功能
- **使用说明**: 
  - **多文件合并模式**：
    1. 选择"多文件合并"模式
    2. 点击"添加文件"或"添加文件夹"选择要合并的Excel文件
    3. 点击"合并设置"配置跳过行数、标题行位置等参数
    4. 点击"执行合并"开始处理多个Excel表格
  - **单文件多工作表合并模式**：
    1. 选择"单文件多工作表合并"模式
    2. 点击"浏览"选择包含多个工作表的Excel文件
    3. 查看工作表预览列表
    4. 点击"合并设置"配置处理参数
    5. 点击"执行合并"开始处理同一文件中的多个工作表
  6. 在"数据预览"选项卡查看合并结果
  7. 点击"保存结果"将合并后的数据导出为新的Excel文件

### 6. Excel去重工具 (ExcelDeduplication)
- **功能描述**: 用于Excel表格数据的去重处理
- **主要特性**: 
  - 支持全行匹配去重或指定列去重
  - 可选择保留首条记录或最后一条记录
  - 支持多列组合去重
  - 可选忽略大小写和空格
  - 提供去重前后数据对比
  - 显示详细的去重统计信息
- **使用说明**: 
  1. 选择要处理的Excel文件
  2. 点击"去重设置"配置去重参数
     - 全行匹配：基于整行数据进行去重
     - 指定列：基于选定的列进行去重
  3. 点击"执行去重"开始处理数据
  4. 在"数据对比"选项卡查看去重前后的数据
  5. 查看去重统计信息（删除行数、删除比例等）
  6. 点击"保存结果"将去重后的数据导出为新的Excel文件

### 7. 图片水印工具 (ImageWatermark)
- **功能描述**: 为图片添加水印的工具
- **主要特性**: 
  - 支持文字水印和图片水印
  - 可自定义水印内容、位置、透明度、字体等
  - 支持批量处理图片
  - 实时预览水印效果
  - 支持多种图片格式（JPG、PNG、BMP等）
- **使用说明**: 
  1. 选择要添加水印的图片（支持单张或多张）
  2. 选择水印类型（文字或图片）
  3. 配置水印参数：
     - 文字水印：设置文字内容、字体、大小、颜色、透明度等
     - 图片水印：选择水印图片、设置大小、透明度等
  4. 调整水印位置（九宫格位置或自定义坐标）
  5. 预览水印效果
  6. 点击"添加水印"处理图片
  7. 保存处理后的图片

### 8. 插件管理器 (PluginManagerTool)
- **功能描述**: 从远程仓库浏览、下载和管理插件
- **主要特性**: 
  - 浏览远程插件仓库中的所有可用插件
  - 按名称、描述搜索插件
  - 按分类筛选插件（数据工具、图片工具、系统工具、其他）
  - 一键下载并安装插件
  - 卸载不需要的插件
  - 自动检查插件依赖是否满足
  - 支持本地测试仓库（无需服务器）
  - 可配置远程插件仓库URL
  - 显示插件信息：版本、大小、作者、评分等
- **使用说明**: 
  1. 在左侧导航面板点击"插件管理"
  2. 查看可用插件列表
  3. 使用搜索框搜索插件
  4. 使用下拉菜单按分类筛选
  5. 点击"安装"按钮安装插件
  6. 点击"卸载"按钮卸载插件
  7. 点击右上角"设置"按钮配置插件仓库URL
  8. 安装或卸载插件后，**重启应用程序**使更改生效
- **详细说明**: 参考 `docs/PLUGIN_MANAGER_GUIDE.md`

## 开发指南

### 添加新功能模块

1. 在 `worktools/plugins` 目录下创建新的插件文件
2. 继承 `BasePlugin` 类并实现必要的方法
3. 在 `worktools/plugins/__init__.py` 中注册新插件
4. 运行应用程序，新功能将自动加载

### 插件开发最佳实践

1. 保持插件间的独立性，避免直接相互调用
2. 使用信号和槽机制进行跨插件通信
3. 提供完整的插件信息和配置选项
4. 实现状态保存和恢复机制
5. 设计用户友好的界面布局

## 界面设计规范

### 布局原则

1. 左侧导航面板宽度为应用程序宽度的 20-30%
2. 功能区采用网格布局，支持响应式调整
3. 保持一致的配色方案和字体
4. 提供适当的状态反馈和提示信息

### 主题支持

应用程序支持明暗主题切换，可通过菜单中的"视图 > 切换主题"进行配置。主题设置会自动保存，下次启动时会恢复上次选择的主题。

### 状态管理

应用程序支持保存和恢复应用状态：

- **保存状态 (Ctrl+S)**：可选择保存到文件或自动保存到系统
  - 保存到文件：可选择保存位置，生成JSON文件，可随时恢复
  - 自动保存：保存到系统设置，程序关闭时自动保存
  - 保存内容包括：窗口位置和大小、当前激活的插件、各插件的配置状态

- **恢复状态 (Ctrl+R)**：从之前保存的文件恢复状态
  - 可选择保存的JSON文件进行恢复
  - 恢复内容包括：窗口位置和大小、当前激活的插件、各插件的配置状态

### 工具设置按钮

每个工具标题栏右侧都有"设置"按钮，用于打开该工具的设置界面。如果该工具没有设置选项，按钮将显示为灰色不可用状态。

## 部署说明

### 开发环境

1. 安装依赖: `pip install -r requirements.txt`
2. 运行应用: `python main.py`

### 打包发布

可使用 PyInstaller 打包为可执行文件:

```
pyinstaller --windowed --icon=resources/icons/app.ico main.py
```

## 版本历史

- v1.2.0 (2025-12-11):
  - 完善插件管理系统，支持插件文件名与ID完全对应
  - 优化插件管理器UI，增加描述列，改善显示效果
  - 实现插件依赖自动安装，提升用户体验
  - 将所有插件打包为独立zip文件，实现按需下载
  - 调整插件管理器为页内操作，不再使用弹窗提示
  - 修正插件卸载功能，支持所有插件正常卸载
  - 优化表格显示，按钮文字更清晰，操作更直观
  - v1.1.0 的所有修改

- v1.1.0 (2025-12-11):
  - 增加插件管理器插件，支持从远程仓库按需下载和安装插件
  - 支持本地测试仓库，无需服务器即可测试插件管理功能
  - 增加插件管理器设置对话框，可配置插件仓库URL
  - 增加插件管理器使用指南文档 (`docs/PLUGIN_MANAGER_GUIDE.md`)
  - 增加远程插件管理功能设计规范
  - 定义插件仓库JSON格式和插件管理器规范
  - v1.0.10 的所有修改

- v1.0.10 (2025-12-11):
  - 砍掉菜单栏的文件菜单（只有关闭功能，用户可点窗口X关闭）
  - 砍掉菜单栏的设置菜单（与插件设置重复）
  - 砍掉菜单栏的工具菜单（重新加载插件功能无用）
  - 砍掉菜单栏的视图菜单（暂无功能）
  - 精简菜单栏，只保留帮助菜单
  - v1.0.9 的所有修改

- v1.0.9 (2025-12-11):
  - 砍掉主题切换功能（效果不明显）
  - 砍掉重置布局功能（意义不大）
  - 砍掉保存状态和恢复状态功能（功能不明显）
  - 统一插件设置接口，设置跟随插件
  - 编写完整的设计规范文档 `docs/DESIGN_SPEC.md`
  - 取消翻译功能加载，简化启动流程
  - 修复工具设置按钮功能，支持插件设置对话框

- v1.0.0:
  - 建立基础插件架构和三个功能占位模块
  - 实现月汇总工具，支持运输数据自动分析和分类
  - 实现Excel合并工具，支持多文件合并和单文件多工作表合并
  - 实现Excel去重工具，支持多种去重模式
  - 实现图片水印工具，支持文字和图片水印
  - 完善用户界面和交互体验
  - 添加自动更新功能
  - 添加GitHub Actions自动构建和发布流程

## 设计规范

详细的设计规范请参考：`docs/DESIGN_SPEC.md`

包含以下内容：
- 项目架构和核心设计原则
- 插件开发规范
- 插件发布规范（包含远程插件管理）
- UI 设计规范
- 功能设计原则
- 代码规范
- 多线程处理规范
- 常见问题解答

## 插件管理器指南

详细的使用指南请参考：`docs/PLUGIN_MANAGER_GUIDE.md`

包含以下内容：
- 插件管理器功能特性
- 浏览、搜索、筛选插件
- 安装和卸载插件
- 配置插件仓库URL
- 部署远程插件仓库
- 开发自己的插件
- 常见问题解答

## 联系方式

如有问题或建议，请通过项目仓库提交issue。