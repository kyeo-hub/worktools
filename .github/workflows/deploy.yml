name: Deploy to GitHub Pages

on:
  push:
    tags:
      - 'v*'  # 只有推送v开头的tag时才触发

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: windows-latest  # Windows环境才能打包exe
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整历史，包括tags
    
    - name: Get version from tag
      id: get_version
      shell: pwsh
      run: |
        # 从tag获取版本号 (v1.0.0 -> 1.0.0)
        $VERSION = $env:GITHUB_REF -replace 'refs/tags/v', ''
        echo "VERSION=$VERSION" | Out-File -FilePath $env:GITHUB_ENV -Append
        echo "version=$VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        Write-Host "构建版本: $VERSION"
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller Pillow PyQt5 pandas openpyxl numpy psutil pyqtgraph
        
    # Windows自带zip功能，无需安装
    
    - name: Update Version Files
      env:
        VERSION: ${{ env.VERSION }}
      shell: pwsh
      run: |
        $version = $env:VERSION
        
        $jsonContent = Get-Content 'version.json' -Raw | ConvertFrom-Json
        $jsonContent.version = $version
        $jsonContent.update_url = 'https://tools.kyeo.top/updates/version.json'
        $jsonContent.download_url = "https://tools.kyeo.top/updates/WorkTools_v$version.zip"
        $jsonContent | ConvertTo-Json -Depth 10 | Set-Content 'version.json' -Encoding UTF8
        
        Write-Host "version.json updated to: $version"
    
    - name: Build Application
      env:
        VERSION: ${{ env.VERSION }}
        PYTHONIOENCODING: utf-8
        CHCP: 65001
      shell: pwsh
      run: |
        chcp 65001 | Out-Null
        $env:PYTHONIOENCODING = "utf-8"
        
        Write-Host "[OK] 开始打包，版本: $env:VERSION"
        Write-Host "[OK] 当前目录: $(Get-Location)"
        
        # 执行打包（VERSION环境变量会被build.py读取）
        python build.py clean
        python build.py build
        
        # 检查打包结果
        if (Test-Path "dist/WorkTools.exe") {
          $size = (Get-Item "dist/WorkTools.exe").Length / 1MB
          Write-Host "[OK] 打包成功: dist/WorkTools.exe ($([math]::Round($size,2)) MB)"
        } else {
          Write-Error "[ERROR] 打包失败: dist/WorkTools.exe 不存在!"
          Write-Host "[DEBUG] dist 目录内容:"
          Get-ChildItem dist/ -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "  - $($_.Name)" }
          exit 1
        }
    
    - name: Create Update Package
      env:
        VERSION: ${{ env.VERSION }}
      shell: pwsh
      run: |
        Write-Host "创建更新包，版本: $env:VERSION"
        
        # 检查 exe 是否存在
        if (-not (Test-Path "dist/WorkTools.exe")) {
          Write-Error "错误: dist/WorkTools.exe 不存在!"
          exit 1
        }
        
        # 创建更新目录
        New-Item -ItemType Directory -Force -Path update_package | Out-Null
        
        # 复制主程序
        Copy-Item dist/WorkTools.exe update_package/
        
        # 复制版本文件
        Copy-Item version.json update_package/
        
        # 创建ZIP包
        Compress-Archive -Path update_package/* -DestinationPath "WorkTools_v$env:VERSION.zip" -Force
        
        # 生成服务器版本文件
        $version = $env:VERSION
        $changelog = @(
            "新增图片水印功能",
            "支持时间地点水印样式",
            "支持实时天气获取",
            "支持自定义水印样式",
            "新增API配置功能",
            "新增自动更新功能"
        )
        
        $serverVersion = @{
            version = $version
            app_name = "WorkTools"
            changelog = $changelog
            download_url = "https://tools.kyeo.top/updates/WorkTools_v$version.zip"
            mandatory = $false
            published_at = "2024-02-05"
            min_version = "1.0.0"
        }
        
        $serverVersion | ConvertTo-Json -Depth 10 | Set-Content 'server/version.json' -Encoding UTF8
        
        Write-Host "服务器版本文件已生成: $version"
        
        # 清理
        Remove-Item -Recurse -Force update_package
        
        Write-Host "更新包创建完成"
        Get-ChildItem WorkTools_v*.zip | Select-Object Name, @{N="Size(MB)";E={[math]::Round($_.Length/1MB,2)}}
    
    - name: Prepare Pages
      env:
        VERSION: ${{ env.VERSION }}
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path _site/updates | Out-Null
        
        # 检查更新包是否存在
        $zipFile = "WorkTools_v$env:VERSION.zip"
        if (-not (Test-Path $zipFile)) {
          Write-Error "[ERROR] 更新包不存在: $zipFile"
          exit 1
        }
        
        # 检查更新包内容
        Write-Host "[OK] 更新包大小: $([math]::Round((Get-Item $zipFile).Length/1MB, 2)) MB"
        Write-Host "[OK] 更新包内容:"
        Expand-Archive -Path $zipFile -DestinationPath "_temp_check" -Force
        Get-ChildItem "_temp_check/" -Recurse | ForEach-Object { 
          $size = if ($_.Length) { " ($([math]::Round($_.Length/1KB, 2)) KB)" } else { "" }
          Write-Host "  - $($_.FullName.Replace((Resolve-Path _temp_check).Path, ''))$size"
        }
        Remove-Item -Recurse -Force "_temp_check"
        
        # 复制版本文件
        Copy-Item server/version.json _site/updates/version.json
        
        # 复制更新包
        Copy-Item $zipFile _site/updates/
        
        # 创建CNAME文件（自定义域名）
        "tools.kyeo.top" | Out-File -FilePath _site/CNAME -Encoding utf8
        
        # 生成首页
        python .github/scripts/generate_index.py
        
        Write-Host "[OK] 站点文件准备完成"
        Write-Host "[OK] 最终文件列表:"
        Get-ChildItem _site/ -Recurse | ForEach-Object {
          $relPath = $_.FullName.Replace((Resolve-Path _site).Path, '').TrimStart('\')
          if ($_.Length) {
            Write-Host "  - $relPath ($([math]::Round($_.Length/1KB, 2)) KB)"
          } else {
            Write-Host "  - $relPath/"
          }
        }
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '_site'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Output Summary
      env:
        VERSION: ${{ env.VERSION }}
      shell: pwsh
      run: |
        Write-Host "部署成功！"
        Write-Host ""
        Write-Host "版本: v$env:VERSION"
        Write-Host "网站: https://tools.kyeo.top/"
        Write-Host "版本文件: https://tools.kyeo.top/updates/version.json"
        Write-Host ""
        Write-Host "用户可以通过以下地址检查更新:"
        Write-Host "  https://tools.kyeo.top/updates/version.json"
